{% extends "base.html" %}

{% block title %}CSV - {{ csv_file }}{% endblock %}

{% block content %}
    <h2>CSV - {{ csv_file }}</h2>
    <form method="post" id="csvForm">
        <div class="table-container">
            <table class="table table-bordered" id="csvTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select_all"></th>
                        {% for title in titles %}
                            <th>{{ title }}</th>
                        {% endfor %}
                    </tr>
                    <tr>
                        <th></th>
                        {% for title in titles %}
                            {% if title in ["rating", "plex_rating", "view_count", "file_size", "local_file_size", "remote_file_size", "largest_file_size"] %}
                                <th>
                                    <input type="text" id="filter_{{ title }}" placeholder="Filtrer {{ title }}" class="column-filter">
                                </th>
                            {% elif title in ["added_at", "release_date"] %}
                                <th>
                                    <input type="text" id="filter_{{ title }}" placeholder="Filtrer {{ title }} (yyyy-mm-dd)" class="column-filter">
                                </th>
                            {% elif title == "title" or title == "Bibliothèque" or title == "local_path" %}
                                <th>
                                    <input type="text" id="filter_{{ title }}" placeholder="Filtrer {{ title }}" class="column-filter">
                                </th>
                            {% else %}
                                <th><input type="text" placeholder="Filtrer {{ title }}" class="column-filter"></th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for index, row in df.iterrows() %}
                        <tr>
                            <td><input type="checkbox" class="row-select" name="selected_rows" value="{{ index }}"></td>
                            {% for title in titles %}
                                <td>
                                    {% if title == "title" %}
                                        <a href="https://www.google.com/search?q={{ 'film ' if 'unwatched_movies' in csv_file else 'série ' }}{{ row[title] }}" target="_blank">
                                            {{ row[title] }}
                                        </a>
                                    {% elif title == "local_path" %}
                                        {{ row[title] }}
                                    {% else %}
                                        {% if row[title] == '' or row[title] == 'N/A' %}
                                            N/A
                                        {% else %}
                                            {{ row[title] }}
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Boutons pour définir l'action sur les lignes sélectionnées -->
        {% if csv_file in ['common_movies.csv', 'common_series.csv'] %}
            <!-- Affichage pour les CSV de comparaison des doublons -->
            <div class="action-buttons">
                <button type="button" id="set_selected_d" class="btn btn-secondary">Définir les sélectionnés en suppression local</button>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </div>
        {% else %}
            <!-- Affichage pour les autres CSV -->
            <div class="action-buttons">
                <button type="button" id="set_selected_a" class="btn btn-secondary">Définir les sélectionnés en archive</button>
                <button type="button" id="set_selected_d" class="btn btn-secondary">Définir les sélectionnés en suppression</button>
                <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            </div>
        {% endif %}
    </form>

    <!-- Boutons "Télécharger le CSV" et "Traiter le CSV" -->
    <div class="action-buttons">
        <a href="{{ url_for('download_csv', csv_file=csv_file) }}" class="btn btn-primary">Télécharger le CSV</a>
        <form action="{{ url_for('process_csv', csv_file=csv_file) }}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-warning">Traiter le CSV</button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialisation de DataTable
        var table = $('#csvTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": true,
            "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
            // Vous pouvez ajouter "pageLength": 25 si vous souhaitez que 25 soit la valeur par défaut
        });

        // Fonction pour interpréter les opérateurs de comparaison
        function parseFilterValue(inputValue) {
            var operator = inputValue.match(/^[<>]=?/); // Match les opérateurs (<, >, <=, >=)
            var value = inputValue.replace(/^[<>]=?/, '').trim(); // Extrait la valeur (nombre ou date)
            return { operator: operator ? operator[0] : null, value: value };
        }

        // Fonction pour vérifier et formater les dates
        function parseDate(dateStr) {
            var parts = dateStr.split('-');
            if (parts.length === 3) {
                var year = parseInt(parts[0], 10);
                var month = parseInt(parts[1], 10) - 1;
                var day = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }
            return null;
        }

        // Obtenir les indices des colonnes par nom
        var columnIndices = {};
        $('#csvTable thead tr:eq(0) th').each(function(index) {
            var columnName = $(this).text();
            if (columnName) {
                columnIndices[columnName] = index;
            }
        });

        // Ajout de 'title', 'Bibliothèque', 'view_count' et 'local_path' dans les filtres
        var filters = [
            { id: 'title', type: 'string' },
            { id: 'Bibliothèque', type: 'string' },
            { id: 'view_count', type: 'number' },
            { id: 'rating', type: 'number' },
            { id: 'plex_rating', type: 'number' },
            { id: 'file_size', type: 'number' },
            { id: 'local_file_size', type: 'number' },
            { id: 'remote_file_size', type: 'number' },
            { id: 'largest_file_size', type: 'number' },
            { id: 'added_at', type: 'date' },
            { id: 'release_date', type: 'date' },
            { id: 'local_path', type: 'string' }
        ];

        // Filtre personnalisé pour les colonnes numériques, dates et string
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                // Filtrage dynamique basé sur les colonnes disponibles
                for (var i = 0; i < filters.length; i++) {
                    var filter = filters[i];
                    var filterValue = $('#filter_' + filter.id).val();
                    if (filterValue && columnIndices[filter.id] !== undefined) {
                        var dataValue = data[columnIndices[filter.id]];

                        if (filter.type === 'number') {
                            var numericValue = parseFloat(dataValue.replace(' Go', '').replace(',', '.')) || 0;
                            var filterParsed = parseFilterValue(filterValue);
                            var filterNumeric = parseFloat(filterParsed.value);
                            if (!isNaN(filterNumeric)) {
                                switch (filterParsed.operator) {
                                    case '>': if (!(numericValue > filterNumeric)) return false; break;
                                    case '>=': if (!(numericValue >= filterNumeric)) return false; break;
                                    case '<': if (!(numericValue < filterNumeric)) return false; break;
                                    case '<=': if (!(numericValue <= filterNumeric)) return false; break;
                                    default: if (numericValue != filterNumeric) return false; break;
                                }
                            }
                        } else if (filter.type === 'date') {
                            var dateValue = parseDate(dataValue);
                            var filterParsed = parseFilterValue(filterValue);
                            var filterDate = parseDate(filterParsed.value);
                            if (filterDate && dateValue) {
                                if (!isNaN(dateValue.getTime())) {
                                    switch (filterParsed.operator) {
                                        case '>': if (!(dateValue.getTime() > filterDate.getTime())) return false; break;
                                        case '>=': if (!(dateValue.getTime() >= filterDate.getTime())) return false; break;
                                        case '<': if (!(dateValue.getTime() < filterDate.getTime())) return false; break;
                                        case '<=': if (!(dateValue.getTime() <= filterDate.getTime())) return false; break;
                                        default: if (dateValue.getTime() !== filterDate.getTime()) return false; break;
                                    }
                                }
                            }
                        } else if (filter.type === 'string') {
                            var filterText = filterValue.toLowerCase();
                            var dataText = dataValue.toLowerCase();
                            if (dataText.indexOf(filterText) === -1) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            }
        );

        // Appliquer le filtre lorsque les champs changent
        $('.column-filter').on('keyup change', function() {
            table.draw();
        });

        // Sélectionner / Désélectionner toutes les cases visibles
        $('#select_all').on('click', function() {
            var rows = table.rows({ 'search': 'applied' }).nodes();
            $('input[type="checkbox"].row-select', rows).prop('checked', this.checked);
        });

        // Désélectionner "Sélectionner tout" si une case est décochée
        $('#csvTable tbody').on('change', 'input[type="checkbox"].row-select', function() {
            if (!this.checked) {
                var el = $('#select_all').get(0);
                if (el && el.checked && ('indeterminate' in el)) {
                    el.indeterminate = true;
                }
            }
        });

        // Définir l'action sur les lignes sélectionnées
        {% if csv_file in ['common_movies.csv', 'common_series.csv'] %}
            // Pour les doublons, uniquement la suppression locale
            $('#set_selected_d').on('click', function() {
                setActionOnSelectedRows('D');
            });
        {% else %}
            // Pour les autres CSV, archive et suppression
            $('#set_selected_a').on('click', function() {
                setActionOnSelectedRows('A');
            });
            $('#set_selected_d').on('click', function() {
                setActionOnSelectedRows('D');
            });
        {% endif %}

        function setActionOnSelectedRows(action) {
            var rows = table.rows({ 'search': 'applied' }).nodes();
            $('input[type="checkbox"].row-select:checked', rows).each(function() {
                var row = $(this).closest('tr');
                var index = $(this).val();
                // Ajouter un champ caché pour envoyer l'action au serveur
                $('<input>').attr({
                    type: 'hidden',
                    name: 'action_' + index,
                    value: action
                }).appendTo('#csvForm');
                // Mettre à jour la colonne "Action" dans le tableau affiché
                var actionCellIndex = columnIndices['Action'];
                if (actionCellIndex !== undefined) {
                    var actionCell = row.find('td').eq(actionCellIndex);
                    actionCell.text(action);
                }
            });
        }
    });
</script>
{% endblock %}
